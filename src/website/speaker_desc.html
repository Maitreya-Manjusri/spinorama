<%
  print_warning = False
  default = meta[speaker].get('default_measurement')
  if default != g_key:
      print_warning = True
      default_origin = meta[speaker]['measurements'].get(default).get('origin')
      default_origin = default_origin.replace('Vendors-', '')
%>
% if print_warning:
<article class="message is-warning">
  <h4>Notice</h4>
  <div class="message-header">
    <p>Warning</p>
    <button class="delete" aria-label="delete"></button>
  </div>
  <div class="message-body">
    We have multiple measurements for this speaker. Click
    <a href="../${default_origin | u}/index_${default}.html">here</a> to
    see the default one (which is higher quality if we have one
    measurement better than the others).
  </div>
</article>
% endif


<article class="message is-info">
  <h4>What we know about the measurement:</h4>
  <div class="message-header">
    <p>
      ${meta[speaker].get('brand')} ${meta[speaker].get('model')} is
      % if meta[speaker].get('type', '') == 'active':
      an active
      % else:
      a passive
      % endif
      ${meta[speaker].get('shape')} speaker
      <%
	price =meta[speaker].get('price', '?')
	%>
      % if price not in ('?', ''):
          that cost around ${meta[speaker].get('price', '?')}USD
      %     if meta[speaker].get('amount', '?') != '?' and meta[speaker].get('shape') != 'center':
      %         if meta[speaker].get('amount') == 'pair':
                  for a pair
      %         else:
                  each
      %         endif
      %     endif
      % endif
.
    </p>
  </div>
  <div class="message-body">
    <div class="content">
      <ul>
<%
    estimates = None
    pref_rating = None
    notes = None
    specifications = None
    default = meta[speaker].get('default_measurement')
    if default is not None and default in meta[speaker]['measurements'].keys():
        estimates = meta[speaker]['measurements'][default].get('estimates', None)
        pref_rating = meta[speaker]['measurements'][default].get('pref_rating', None)
        pref_rating_eq = meta[speaker]['measurements'][default].get('pref_rating_eq', None)
        notes = meta[speaker]['measurements'][default].get('notes', None)
    sensitivity_data = meta[speaker]["measurements"].get('sensitivity', {})
    sensitivity = sensitivity_data.get('computed', None)
    sensitivity_1m = sensitivity_data.get('sensitivity_1m', None)
    sensitivity_distance = sensitivity_data.get('sensitivity_distance', None)
    if g_key in meta[speaker]['measurements'].keys():
        specifications = meta[speaker]['measurements'][g_key].get('specifications', None)
%>
% if g_key in meta[speaker]["measurements"]:
<li>Quality of the measurement data is
%   if  meta[speaker]["measurements"][g_key].get("quality", "?") != "?":
    <b>${meta[speaker]["measurements"][g_key]["quality"]}</b>
%   else:
    <b>unknown</b>
%   endif
.</li>
%   if meta[speaker]["measurements"][g_key].get("origin", "?") != "?":
<%
  clean_key = g_key
  if g_key == "misc-sr":
      clean_key="Sound and Recording"
  elif g_key == "misc-pp":
      clean_key="Production Partner"
  else:
      clean_key = meta[speaker]["measurements"][g_key].get("origin").replace('Vendors-', '')
%>
<li>
  Origin of the data is ${clean_key}.
</li>
%   endif
%   if meta[speaker]["measurements"][g_key].get("format", "?") != "?":
<li>
  Format of the data is
%     if meta[speaker]["measurements"][g_key]["format"] == 'webplotdigitizer':
  a scanned image
%     elif meta[speaker]["measurements"][g_key]["format"] == 'klippel':
  generated by a Klippel NFS
%     elif meta[speaker]["measurements"][g_key]["format"] == 'rewstextdump':
  an ascii file
%     elif meta[speaker]["measurements"][g_key]["format"] == 'spl_hv_txt':
  a set of 36 horizontal and 36 vertical measurements
%     elif meta[speaker]["measurements"][g_key]["format"] == 'gll_hv_txt':
  a GLL file
%     endif
.</li>
%   endif
%   if meta[speaker]["measurements"][g_key].get("extras", "?") != "?":
<li>
%     if meta[speaker]["measurements"][g_key]["extras"].get("is_equed"):
  Warning: this measurement was already process with an equalizer
%     endif
.</li>
%   endif
% endif
% if sensitivity is not None:
%    if sensitivity_1m is not None:
<li>
  Sensitivity: <b>${'{0:.1f}'.format(sensitivity_1m)}</b>dB (avg. 100Hz-1kHz for 2.83V estimated at <b>1m</b>)
%        if sensitivity_distance is not None:
  . Sensitivity computed at the measurement distance
  (${sensitivity_distance})} over the same frequency range: ${'{0:.1f}'.format(sensitivity_distance)}.
%        endif
</li>
%    else:
<li>
  Sensitivity: <b>${'{0:.1f}'.format(sensitivity)}</b>dB (avg. 100Hz-1kHz for 2.83V measured at <b>1m</b>).
</li>
%    endif
% endif
% if estimates is not None:
%   if estimates.get('ref_3dB', '?') !=  '?':
<li>
  <b>-3dB</b> (resp. -6db) point v.s. reference is at <b>${estimates.get('ref_3dB')}Hz</b> (resp. ${estimates.get('ref_6dB')}Hz).
</li>
%   endif
%   if estimates.get('ref_from', '?') !=  '?':
<li>
      Reference level is normalised to ${estimates.get('ref_level')}dB
      computed over the frequency range [${estimates.get('ref_from')}Hz,
      ${estimates.get('ref_to')}Hz].
</li>
%   endif
%   if estimates.get('ref_band', '?') !=  '?':
<li>
      Frequency deviation is <b>${estimates.get('ref_band')}dB</b> over the same frequency range.
</li>
%   endif
%   if estimates.get('dir_horizontal', '?') !=  '?' or estimates.get('dir_vertical', '?') !=  '?':
<li>Directivity
  <ul>
%   endif
%   if estimates.get('dir_horizontal', '?') !=  '?':
    <li>
      Horizontal directivity
      is (<b>${estimates.get('dir_horizontal_m')}&deg;, ${estimates.get('dir_horizontal_p')}&deg;</b>)
      between 1kHz and 10kHz. Angle computed for +/-6dB.
    </li>
%   endif
%   if estimates.get('dir_vertical', '?') !=  '?':
    <li>
      Vertical directivity
      is (<b>${estimates.get('dir_vertical_m')}&deg;, ${estimates.get('dir_vertical_p')}&deg;</b>)
      between 1kHz and 10kHz. Angle computed for +/-6dB.
    </li>
%   endif
%   if estimates.get('dir_horizontal', '?') !=  '?' or estimates.get('dir_vertical', '?') !=  '?':
  </ul>
</li>
%   endif
% endif

% if pref_rating is not None or pref_rating_eq is not None:
<li>Tonality (Preference) Score
  <ul>
% endif

% if pref_rating is not None:
    <li>Tonality (Preference) Score is <b>${pref_rating.get('pref_score')}</b>
      and would be <b>${pref_rating.get('pref_score_wsub')}</b> with a
        perfect subwoofer.
      <ul>
        <li>Details:
        NBD: ON ${pref_rating.get('nbd_on_axis')},
        LW ${pref_rating.get('nbd_listening_window')}, SP
        ${pref_rating.get('nbd_sound_power')}, PIR
        ${pref_rating.get('nbd_pred_in_room')}; SM:
        SP${pref_rating.get('sm_sound_power')},
        PIR${pref_rating.get('sm_pred_in_room')}; LFQ
        ${pref_rating.get('lfq')}, LFX ${pref_rating.get('lfx_hz')}Hz
        </li>
      </ul>
    </li>
% endif
% if pref_rating_eq is not None:
    <li>Tonality (Preference) Score is <b>${pref_rating_eq.get('pref_score')}</b>
      with an EQ and would be <b>${pref_rating_eq.get('pref_score_wsub')}</b> with a
        perfect subwoofer and the same EQ.
       <ul>
          <li>Details:
        NBD: ON ${pref_rating_eq.get('nbd_on_axis')},
        LW ${pref_rating_eq.get('nbd_listening_window')}, SP
        ${pref_rating_eq.get('nbd_sound_power')}, PIR
        ${pref_rating_eq.get('nbd_pred_in_room')}; SM:
        SP${pref_rating_eq.get('sm_sound_power')},
        PIR${pref_rating_eq.get('sm_pred_in_room')}; LFQ ${pref_rating_eq.get('lfq')}, LFX ${pref_rating_eq.get('lfx_hz')}Hz
          </li>
       </ul>
    </li>
% endif
% if pref_rating is not None or pref_rating_eq is not None:
</ul>
</li>
% endif

<%
  review = None
  reviews = None
  h_or_v = None
  if "default_measurement" in meta[speaker]:
    default =  meta[speaker]["default_measurement"]
    compute = meta[speaker]["measurements"][default]
    review = compute.get("review", None)
    reviews = compute.get("reviews", None)
    if "horizontal" in default:
      h_or_v = "Horizontal"
    elif "vertical" in default:
      h_or_v = "Vertical"
%>
% if h_or_v is not None:
<li>${h_or_v} measurement</li>
% endif
% if review is not None:
<li>Link to <a href="${review}">Original review</a>.</li>
% endif
% if reviews is not None:
<li>
%   for pos, (key, review) in enumerate(reviews.items()):
%     if pos == 0:
Link to original Review: <a href="${review}">${key} review</a>.
%     elif pos == 1:
Links to other reviews: <a href="${review}">${key} review</a>
%     else:
, <a href="${review}">${key} review</a>
%     endif
%   endfor
.
</li>
% endif
% if notes is not None:
<li>
  <b>Note</b>: ${notes}
</li>
% endif
<% if specifications is not None:
   dispersion = specifications.get('dispersion')
   if dispersion is not None:
       horizontal = dispersion.get('horizontal')
       vertical = dispersion.get('vertical')
   sensitivity = specifications.get('sensitivity')
   impedance = specifications.get('impedance')
   spl = specifications.get('SPL')
   size = specifications.get('size')
   if size is not None:
       height = size.get('height')
       width = size.get('width')
       depth = size.get('depth')
   weight = specifications.get('weight')
%>
% if specifications is not None:
<li>
  <b>Vendor specifications</b>:
  <ul>
%     if dispersion is not None:
    <li>Dispersion: ${horizontal}&deg; horizontal and ${vertical}&deg; vertical.</li>
%     endif
%     if sensitivity is not None:
    <li>Sensitivity ${sensitivity} dB</li>
%     endif
%     if impedance is not None:
    <li>Impedance ${impedance} Ohm</li>
%     endif
%     if spl is not None:
    <li>SPL
       <ul>
% for k in spl:
         <li>${k}: ${spl[k]} dB</li>
% endfor
       </ul>
    </li>
</li>
%     endif
%     if size is not None:
<li>Size
  <ul>
    <li>Width ${width}mm</li>
    <li>Height ${height}mm</li>
    <li>Depth ${depth} mm)</li>
  </ul>
</li>
%     endif
%     if weight is not None:
<li>Weight ${weight} kg</li>
%     endif
</ul>
</li>
% endif
      </ul>
    </div>
  </div>
</article>
